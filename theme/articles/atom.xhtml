<?r

articles = get_entries(
  'articles',
  :user     => true,
  :order_by => :created_at,
  :order    => :desc
)

response.header['Content-Type'] = 'application/atom+xml'

?>
<?xml version="1.0" encoding="utf-8" ?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"
xml:base="http://yorickpeterse.com">
    <!-- Base description of the feed -->
    <id>tag:yorickpeterse.com,2011-05-03:/articles/1304446233</id>
    <title>#{get_setting(:website_name).value}</title>

    <author>
        <name>Yorick Peterse</name>
        <email>yorickpeterse@gmail.com</email>
    </author>

    <category term="programming" label="Programming" />
    <updated>#{articles[0].created_at.strftime('%Y-%m-%dT%H:%M:%SZ')}</updated>

    <link href="http://yorickpeterse.com/articles/atom" rel="self" />

    <?r articles.each do |article| ?>
    <?r id_date = article.created_at.strftime('%Y-%m-%d') ?>
    <entry>
        <id>tag:yorickpeterse.com,#{id_date}:/articles/#{article.slug}</id>

        <title>#{article.title}</title>

        <author>
            <name>#{article.user.name}</name>
        </author>

        <updated>#{article.created_at.strftime('%Y-%m-%dT%H:%M:%SZ')}</updated>

        <link href="http://yorickpeterse.com/articles/#{article.slug}"
        type="text/html" rel="alternate" />

        <link href="http://yorickpeterse.com/articles/#{article.slug}.md"
        rel="alternate" type="text/plain" />

        <content type="xhtml">
            <div xmlns="http://www.w3.org/1999/xhtml">
                #{Zen::Security.sanitize(article.fields[:body])}
            </div>
        </content>
    </entry>
    <?r end ?>
</feed>
